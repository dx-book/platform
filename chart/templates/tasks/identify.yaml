apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: identify
  namespace: tekton-tasks
  annotations:
    argocd.argoproj.io/compare-options: IgnoreExtraneous
spec:
  description: Identifies runtime, extracts the version number and stores it in result.
  params:
    - name: environments
      description: GitOps environments repository git url
      type: string
    - name: path
      description: Subpath containing the applications metadata yaml definition
      type: string
    - description: revision type
      name: revision_type
      type: string
    - default: ""
      description: Subdirectory inside the `source` Workspace
      name: subdirectory
      type: string
  results:
    - name: version
      description: parsed version from manifest files
    - name: runtime
      description: detected runtime
    - name: shared
      description: the shared values from the environments/shared.yaml
  workspaces:
    - name: source
      description: Workspace where source is cloned to.
    - name: ssh-directory
      optional: true
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before git commands are executed. Used to authenticate
        with the git remote when performing the clone. Binding a Secret to this
        Workspace is strongly recommended over other volume types.
  steps:
    - name: detect-version
      workingDir: $(workspaces.source.path)/$(params.subdirectory)
      image: registry.access.redhat.com/ubi8/toolbox:8.5
      script: |
        #!/bin/sh
        echo "Detected branch type: $(params.revision_type)"
        package=package.json
        runtime=undefined
        if [ -f $package ]; then
            runtime=nodejs
        else
            echo "Missing package.json"
        fi

        if [ "$runtime" = "nodejs" ]; then
          version=$(cat $package \
          | grep version \
          | head -1 \
          | awk -F: '{ print $2 }' \
          | sed 's/[",]//g')

          version=$(echo -e $version)
        fi

        echo "Detected runtime: $runtime"
        echo "Detected version: $version"
        printf %s "$version" >> /tekton/results/version
        printf %s "$runtime" >> /tekton/results/runtime

    - name: environments
      image: registry.access.redhat.com/ubi8/nodejs-16
      env:
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.ssh-directory.path)
      script: |
        #!/bin/sh
        # here we'll clone the environments repository
        # and make it available within this workspace for later usage

        cp -R ${WORKSPACE_SSH_DIRECTORY_PATH} $HOME/.ssh
        chmod 700 $HOME/.ssh
        chmod -R 400 $HOME/.ssh/*
        ssh-keyscan -t rsa github.com >> $HOME/.ssh/known_hosts

        ssh -T git@github.com
        git clone $(params.environments)
        cd environments
        ls -ls

        printf %s "$(cat shared.yaml)" >> /tekton/results/shared
